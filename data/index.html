<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32-S3 Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #terminal {
      height: 200px;
      overflow-y: auto;
      background-color: #1a1a1a;
      color: #ffffff;
      font-family: monospace;
      padding: 10px;
    }
    .input-status {
      background-color: #e0e0e0;
      padding: 5px;
      border-radius: 4px;
      margin: 2px 0;
    }
    .output-btn {
      transition: background-color 0.3s;
    }
    .output-btn.on {
      background-color: #10b981; /* Xanh lá */
    }
    .output-btn.off {
      background-color: #ef4444; /* Đỏ */
    }
    .lora-info {
      background-color: #f3f4f6;
      padding: 10px;
      border-radius: 6px;
      margin: 5px 0;
    }
    .lora-info-label {
      font-weight: bold;
      color: #374151;
    }
    .lora-info-value {
      color: #1f2937;
    }
    select, input[type="number"] {
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 5px;
      width: 100%;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4">
    <!-- Header -->
    <div id="dashboard" class="mb-6">
      <h1 class="text-2xl font-bold mb-4">ESP32-S3 Dashboard</h1>
      <p id="connection-status" class="mb-4 text-lg">WebSocket: Disconnected</p>
      <div class="flex space-x-4">
        <button onclick="showPage('console')" class="bg-blue-500 text-white px-4 py-2 rounded">Console</button>
        <button onclick="showPage('lora')" class="bg-blue-500 text-white px-4 py-2 rounded">LoRa E32 Info</button>
      </div>
    </div>

    <!-- Console Page -->
    <div id="console" class="hidden">
      <h2 class="text-xl font-bold mb-4">Console</h2>
      <div id="terminal" class="mb-6"></div>

      <!-- Input Status Section -->
      <div class="mb-6">
        <h3 class="font-semibold text-lg mb-2">Input Status</h3>
        <div id="input-status" class="grid grid-cols-1 gap-2"></div>
      </div>

      <!-- Output Controls Section -->
      <div>
        <h3 class="font-semibold text-lg mb-2">Output Controls</h3>
        <div id="output-controls" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
      </div>

      <!-- System Status Section -->
      <div class="mt-6">
        <h3 class="font-semibold text-lg mb-2">System Status</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <p>Reset Count: <span id="reset-count">0</span></p>
          <p>Free Heap: <span id="free-heap">0</span> bytes</p>
          <p>Free PSRAM: <span id="free-psram">0</span> bytes</p>
          <p>Temperature: <span id="temperature">0</span> °C</p>
          <p>IP Address: <span id="ip-address">0.0.0.0</span></p>
          <p>Uptime: <span id="uptime">0</span> ms</p>
        </div>
      </div>
    </div>

    <!-- LoRa E32 Info Page -->
    <div id="lora" class="hidden">
      <h2 class="text-xl font-bold mb-4">LoRa E32 Information</h2>
      
      <!-- Module Status -->
      <div class="mb-6">
        <h3 class="font-semibold text-lg mb-2">Module Status</h3>
        <div class="lora-info">
          <span class="lora-info-label">Initialized:</span>
          <span id="lora-initialized" class="lora-info-value">NO</span>
        </div>
        <div class="lora-info">
          <span class="lora-info-label">Module Info:</span>
          <span id="lora-module-info" class="lora-info-value">Not available</span>
        </div>
      </div>

      <!-- Address Configuration -->
      <div class="mb-6">
        <h3 class="font-semibold text-lg mb-2">Address Configuration</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="lora-info">
            <span class="lora-info-label">High Address (ADDH):</span>
            <input type="number" id="lora-addh" value="0" min="0" max="255" class="lora-info-value">
          </div>
          <div class="lora-info">
            <span class="lora-info-label">Low Address (ADDL):</span>
            <input type="number" id="lora-addl" value="0" min="0" max="255" class="lora-info-value">
          </div>
          <div class="lora-info">
            <span class="lora-info-label">Channel (CHAN):</span>
            <input type="number" id="lora-chan" value="0" min="0" max="31" class="lora-info-value">
          </div>
        </div>
      </div>

      <!-- RF Configuration -->
      <div class="mb-6">
        <h3 class="font-semibold text-lg mb-2">RF Configuration</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="lora-info">
            <span class="lora-info-label">Air Data Rate:</span>
            <select id="lora-air-data-rate" class="lora-info-value">
              <option value="0">0.3kbps</option>
              <option value="1">1.2kbps</option>
              <option value="2" selected>2.4kbps</option>
              <option value="3">4.8kbps</option>
              <option value="4">9.6kbps</option>
              <option value="5">19.2kbps</option>
            </select>
          </div>
          <div class="lora-info">
            <span class="lora-info-label">Transmission Power:</span>
            <select id="lora-transmission-power" class="lora-info-value">
              <option value="0">30dBm</option>
              <option value="1">27dBm</option>
              <option value="2">24dBm</option>
              <option value="3" selected>20dBm</option>
            </select>
          </div>
          <div class="lora-info">
            <span class="lora-info-label">Wireless Wakeup Time:</span>
            <select id="lora-wireless-wakeup-time" class="lora-info-value">
              <option value="0" selected>250ms</option>
              <option value="1">500ms</option>
              <option value="2">750ms</option>
              <option value="3">1000ms</option>
              <option value="4">1250ms</option>
              <option value="5">1500ms</option>
              <option value="6">1750ms</option>
              <option value="7">2000ms</option>
            </select>
          </div>
          <div class="lora-info">
            <span class="lora-info-label">FEC:</span>
            <select id="lora-fec" class="lora-info-value">
              <option value="0">Off</option>
              <option value="1" selected>On</option>
            </select>
          </div>
        </div>
      </div>

      <!-- UART Configuration -->
      <div class="mb-6">
        <h3 class="font-semibold text-lg mb-2">UART Configuration</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="lora-info">
            <span class="lora-info-label">UART Baud Rate:</span>
            <select id="lora-uart-baud-rate" class="lora-info-value">
              <option value="0">1200</option>
              <option value="1">2400</option>
              <option value="2">4800</option>
              <option value="3" selected>9600</option>
              <option value="4">19200</option>
              <option value="5">38400</option>
              <option value="6">57600</option>
              <option value="7">115200</option>
            </select>
          </div>
          <div class="lora-info">
            <span class="lora-info-label">Parity Bit:</span>
            <select id="lora-parity-bit" class="lora-info-value">
              <option value="0" selected>8N1</option>
              <option value="1">8O1</option>
              <option value="2">8E1</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Options Configuration -->
      <div class="mb-6">
        <h3 class="font-semibold text-lg mb-2">Options Configuration</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="lora-info">
            <span class="lora-info-label">Fixed Transmission:</span>
            <select id="lora-fixed-transmission" class="lora-info-value">
              <option value="0" selected>Transparent</option>
              <option value="1">Fixed</option>
            </select>
          </div>
          <div class="lora-info">
            <span class="lora-info-label">IO Drive Mode:</span>
            <select id="lora-io-drive-mode" class="lora-info-value">
              <option value="0">Open-collector</option>
              <option value="1" selected>Push-pull</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Control Buttons -->
      <div class="flex space-x-4">
        <button onclick="refreshLoRaE32()" class="bg-green-500 text-white px-4 py-2 rounded">Refresh LoRa E32</button>
        <button onclick="getLoRaE32Config()" class="bg-blue-500 text-white px-4 py-2 rounded">Get Configuration</button>
        <button onclick="setLoRaE32Config()" class="bg-purple-500 text-white px-4 py-2 rounded">Set Configuration</button>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    const terminal = document.getElementById('terminal');

    function showPage(pageId) {
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('console').classList.add('hidden');
      document.getElementById('lora').classList.add('hidden');
      document.getElementById(pageId).classList.remove('hidden');
    }

    function appendTerminal(message) {
      const formattedMessage = message.replace(/\n/g, '<br>');
      terminal.innerHTML += formattedMessage + '<br>';
      terminal.scrollTop = terminal.scrollHeight;
      if (terminal.childElementCount > 100) {
        terminal.removeChild(terminal.firstChild);
      }
    }

    function toggleOutput(pin) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const button = document.getElementById(`output-btn-${pin}`);
        const state = button.classList.contains('on');
        button.classList.toggle('on', !state);
        button.classList.toggle('off', state);
        button.textContent = state ? 'OFF' : 'ON';
        ws.send(JSON.stringify({
          action: 'control_output',
          pin: pin,
          state: !state
        }));
      }
    }

    function refreshLoRaE32() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          action: 'refresh_lora_e32'
        }));
        appendTerminal('Refreshing LoRa E32 configuration...');
      }
    }

    function getLoRaE32Config() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          action: 'get_lora_e32_config'
        }));
        appendTerminal('Getting LoRa E32 configuration...');
      }
    }

    function setLoRaE32Config() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const config = {
          action: 'set_lora_e32_config',
          addh: parseInt(document.getElementById('lora-addh').value),
          addl: parseInt(document.getElementById('lora-addl').value),
          chan: parseInt(document.getElementById('lora-chan').value),
          uartParity: parseInt(document.getElementById('lora-parity-bit').value),
          uartBaudRate: parseInt(document.getElementById('lora-uart-baud-rate').value),
          airDataRate: parseInt(document.getElementById('lora-air-data-rate').value),
          fixedTransmission: parseInt(document.getElementById('lora-fixed-transmission').value),
          ioDriveMode: parseInt(document.getElementById('lora-io-drive-mode').value),
          wirelessWakeupTime: parseInt(document.getElementById('lora-wireless-wakeup-time').value),
          fec: parseInt(document.getElementById('lora-fec').value),
          transmissionPower: parseInt(document.getElementById('lora-transmission-power').value)
        };
        ws.send(JSON.stringify(config));
        appendTerminal('Setting LoRa E32 configuration...');
      }
    }

    function updateStatus(data) {
      console.log('WebSocket data received:', data);

      if (data.action === 'system_status') {
        document.getElementById('reset-count').textContent = data.reset_count;
        document.getElementById('free-heap').textContent = data.free_heap;
        document.getElementById('free-psram').textContent = data.free_psram;
        document.getElementById('temperature').textContent = data.temperature.toFixed(2);
        document.getElementById('ip-address').textContent = data.ip_address;
        document.getElementById('uptime').textContent = data.uptime;

        // Update Input Status
        const inputStatus = document.getElementById('input-status');
        inputStatus.innerHTML = '';
        data.inputs.forEach(input => {
          inputStatus.innerHTML += `
            <div class="input-status">
              Pin ${input.pin}: ${input.state}
            </div>`;
          if (document.getElementById(`input-${input.pin}`)?.dataset.state !== input.state) {
            appendTerminal(`Pin ${input.pin} changed to ${input.state}`);
          }
          if (document.getElementById(`input-${input.pin}`)) {
            document.getElementById(`input-${input.pin}`).dataset.state = input.state;
          }
        });

        // Update Output Controls
        const outputControls = document.getElementById('output-controls');
        outputControls.innerHTML = '';
        data.outputs.forEach(output => {
          outputControls.innerHTML += `
            <button id="output-btn-${output.pin}" 
                    class="output-btn px-4 py-2 rounded text-white ${output.state === 'HIGH' ? 'on' : 'off'}"
                    onclick="toggleOutput(${output.pin})">
              ${output.state === 'HIGH' ? 'ON' : 'OFF'}
            </button>`;
        });

        // Update LoRa E32 Information
        if (data.loraE32) {
          document.getElementById('lora-initialized').textContent = data.loraE32.initialized ? 'YES' : 'NO';
          document.getElementById('lora-module-info').textContent = data.loraE32.moduleInfo || 'Not available';
          document.getElementById('lora-addh').value = data.loraE32.addh || 0;
          document.getElementById('lora-addl').value = data.loraE32.addl || 0;
          document.getElementById('lora-chan').value = data.loraE32.chan || 0;
          document.getElementById('lora-frequency').textContent = data.loraE32.frequency || 'Not available';
          document.getElementById('lora-air-data-rate').value = data.loraE32.airDataRate ? data.loraE32.airDataRate.replace('kbps', '') : 2;
          document.getElementById('lora-uart-baud-rate').value = data.loraE32.uartBaudRate ? data.loraE32.uartBaudRate : 3;
          document.getElementById('lora-transmission-power').value = data.loraE32.transmissionPower ? data.loraE32.transmissionPower.replace('dBm', '') : 3;
          document.getElementById('lora-parity-bit').value = data.loraE32.parityBit ? (data.loraE32.parityBit === '8N1' ? 0 : data.loraE32.parityBit === '8O1' ? 1 : 2) : 0;
          document.getElementById('lora-wireless-wakeup-time').value = data.loraE32.wirelessWakeupTime ? data.loraE32.wirelessWakeupTime.replace('ms', '') / 250 : 0;
          document.getElementById('lora-fec').value = data.loraE32.fec === 'On' ? 1 : 0;
          document.getElementById('lora-fixed-transmission').value = data.loraE32.fixedTransmission === 'Transparent' ? 0 : 1;
          document.getElementById('lora-io-drive-mode').value = data.loraE32.ioDriveMode === 'Push-pull' ? 1 : 0;
        }
      } else if (data.action === 'debug') {
        appendTerminal(data.message);
      }
    }

    function initWebSocket() {
      ws = new WebSocket(`ws://192.168.0.105/ws`);
      ws.onopen = () => {
        document.getElementById('connection-status').textContent = 'WebSocket: Connected';
        appendTerminal('WebSocket connected');
        // Request initial LoRa E32 configuration
        ws.send(JSON.stringify({ action: 'get_lora_e32_config' }));
      };
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (!data.action) {
            appendTerminal('Lỗi: Nhận được tin nhắn WebSocket không hợp lệ');
            return;
          }
          updateStatus(data);
        } catch (e) {
          appendTerminal('Lỗi: Không thể phân tích tin nhắn WebSocket');
        }
      };
      ws.onclose = () => {
        document.getElementById('connection-status').textContent = 'WebSocket: Disconnected';
        appendTerminal('WebSocket disconnected');
        setTimeout(initWebSocket, 5000);
      };
    }

    initWebSocket();
    showPage('dashboard');
  </script>
</body>
</html>